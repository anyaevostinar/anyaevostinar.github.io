<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>HW8 EXPLOITING BUFFER OVERFLOWS | Anya E. Vostinar</title>
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="HW8 EXPLOITING BUFFER OVERFLOWS" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="The homepage of Prof. Anya E. Vostinar. I teach computer science and research the evolution of symbiosis using digital evolution and agent-based modeling. I wrote the Symbulation platform." />
<meta property="og:description" content="The homepage of Prof. Anya E. Vostinar. I teach computer science and research the evolution of symbiosis using digital evolution and agent-based modeling. I wrote the Symbulation platform." />
<link rel="canonical" href="http://localhost:4000/classes/208-s24/hw8" />
<meta property="og:url" content="http://localhost:4000/classes/208-s24/hw8" />
<meta property="og:site_name" content="Anya E. Vostinar" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="HW8 EXPLOITING BUFFER OVERFLOWS" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"The homepage of Prof. Anya E. Vostinar. I teach computer science and research the evolution of symbiosis using digital evolution and agent-based modeling. I wrote the Symbulation platform.","headline":"HW8 EXPLOITING BUFFER OVERFLOWS","url":"http://localhost:4000/classes/208-s24/hw8"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Anya E. Vostinar" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Anya E. Vostinar</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/Classes/">Classes</a><a class="page-link" href="/Research/">Research</a><a class="page-link" href="/blog/">Blog</a><a class="page-link" href="/About/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post">

  <header class="post-header">
    <h1 class="post-title">HW8 EXPLOITING BUFFER OVERFLOWS</h1>
  </header>

  <div class="post-content">
    <p>This assignment is an adaptation and contraction by Jeff Ondich of Aaron Bauer’s adaption of a lab developed for the Carnegie Mellon University’s 15-213 (Introduction to Computer Systems) course.</p>

<h2 id="goals">GOALS</h2>
<ul>
  <li>Learn some of the ways that carefully designed malicious input can cause a vulnerable program to behave in ways not intended by the program’s creators.</li>
  <li>Use that knowledge to learn how to avoid creating similar vulnerabilities in your own programs.</li>
  <li>Learn a little bit about how x86-64 machine language is structured.</li>
  <li>Deepen your understanding of the stack structures used to implement C function-calling in x86-64.</li>
  <li>Revisit your gdb skills.</li>
</ul>

<h2 id="logistics">Logistics</h2>
<p>This is a <strong>paired</strong> assignment, so you should work with your partner (either chosen by you or set up by me depending on your form response). If you indicated you would work alone, you can change your mind and join with someone, but you need to let me know asap. As usual, you can get help as detailed in the <a href="collaboration">collaboration</a> document. You should submit only one assignment to Gradescope for your pair and add your partner to the submission. If for some reason you and your partner can’t make things work, you can split, but you have to let me know asap.</p>

<p>This assignment is due Wednesday May 15th at 10pm. As with all assignments, you will have the opportunity to <strong>individually</strong> <a href="revision-process">revise</a> this submission based on feedback.</p>

<h2 id="assessment">Assessment</h2>
<p>To <strong>demonstrate proficiency</strong>, your submission needs to:</p>
<ul>
  <li>Pass phases 1 and 2</li>
</ul>

<p>To <strong>demonstrate mastery</strong>, your submission needs to:</p>
<ul>
  <li>Pass all three phases</li>
</ul>

<p>Your progress through the phases will be automatically tracked as it was during the zoo escape assignment. For this assignment, your entire score will be based on your completion of the three phases of the assignment; all you need to hand in is a document <code class="language-plaintext highlighter-rouge">info.txt</code> that includes your target number (we can see it as well, but it makes it easier on the grader).</p>

<p>Check your progress here: <a href="http://cs208.mathcs.carleton.edu:1866/progress">http://cs208.mathcs.carleton.edu:1866/progress</a></p>

<h2 id="buffer-overflow-attacks">BUFFER OVERFLOW ATTACKS</h2>
<p>Suppose you write a program that includes this function:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">some_function</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">str</span><span class="p">[</span><span class="mi">100</span><span class="p">];</span>
    <span class="kt">int</span> <span class="n">k</span><span class="p">;</span>

    <span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div>

<p>When you call <code class="language-plaintext highlighter-rouge">some_function</code>, a stack frame gets allocated on the system stack (typically via <code class="language-plaintext highlighter-rouge">sub $0xSOMETHING,%rsp</code>) to store the return address, the local variables, and the values saved from the miscellaneous registers that <code class="language-plaintext highlighter-rouge">some_function</code> needs to use (so those registers can be restored to their original values before the function returns). Depending on the specific code in <code class="language-plaintext highlighter-rouge">some_function</code>, the parameters <code class="language-plaintext highlighter-rouge">a</code> and <code class="language-plaintext highlighter-rouge">b</code> might also get stored in the stack frame.</p>

<p>As you might imagine, it would be typical for a compiler to position the local variables <code class="language-plaintext highlighter-rouge">j</code>, <code class="language-plaintext highlighter-rouge">str</code>, and <code class="language-plaintext highlighter-rouge">k</code> adjacent to one another in the memory occupied by the stack frame.</p>

<p>Suppose then that <code class="language-plaintext highlighter-rouge">some_function</code> has been written sloppily and reads user input into <code class="language-plaintext highlighter-rouge">str</code> without checking to make sure the user input fits in the 100 bytes of <code class="language-plaintext highlighter-rouge">str</code>. The excess bytes in the user input will spill over the end of <code class="language-plaintext highlighter-rouge">str</code> and corrupt the contents of <code class="language-plaintext highlighter-rouge">j</code> or <code class="language-plaintext highlighter-rouge">k</code>, depending on whether one of them is stored in memory immediately after <code class="language-plaintext highlighter-rouge">str</code>. If the user input is long enough, it might also corrupt a lot more of the stack (including the stack frames of previous function calls).</p>

<p>Another piece of data in the stack frame is the <em>return address</em>. That is, the stack frame includes the 8-byte address of the instruction immediately following the <code class="language-plaintext highlighter-rouge">call</code> instruction that brought us to <code class="language-plaintext highlighter-rouge">some_function</code> in the first place. When the <code class="language-plaintext highlighter-rouge">ret</code> instruction gets executed by <code class="language-plaintext highlighter-rouge">some_function</code> to return to the function from which it was called, <code class="language-plaintext highlighter-rouge">ret</code> uses the return address as the destination to which to return.</p>

<p>If our users are clever enough, they can type input that will (1) overflow <code class="language-plaintext highlighter-rouge">str</code> and (2) overwrite the return address with the address of some other function. This would cause <code class="language-plaintext highlighter-rouge">some_function</code> to “return” to the wrong place, which could lead to all sorts of mayhem depending on what code resides at that wrong place.</p>

<p>This kind of sneaky user is engaged in what is known as a <a href="https://owasp.org/www-community/attacks/Buffer_overflow_attack">buffer overflow attack</a>. In this assignment, you are going to play the role of buffer-overflow attacker. In the process, you’ll get more familiar with the way function calling works at the assembly language level.</p>

<h2 id="what-to-do">WHAT TO DO</h2>
<ol>
  <li><strong>Get your attack target.</strong> Fill out the form at <a href="http://cs208.mathcs.carleton.edu:1866/">http://cs208.mathcs.carleton.edu:1866/</a> to download your <code class="language-plaintext highlighter-rouge">targetN.tar file</code>. This file is analogous to the <code class="language-plaintext highlighter-rouge">zooN.tar</code> file you obtained during the the <a href="hw7">zoo-escape assignment</a>.</li>
  <li><strong>Move your <code class="language-plaintext highlighter-rouge">targetN.tar</code> file to mantis</strong> and expand it there (with <code class="language-plaintext highlighter-rouge">tar xvf targetN.tar</code>). The <code class="language-plaintext highlighter-rouge">targetN.tar</code> file contains a whole bunch of files, some of which you will not need because we’re doing only a portion of the original lab. The files you will need are:
    <ul>
      <li><code class="language-plaintext highlighter-rouge">ctarget</code> — the executable program that you will attack. This program is vulnerable to code injection attacks.</li>
      <li><code class="language-plaintext highlighter-rouge">ctarget.phaseN</code> for N = 1, 2, and 3 — files where you can put your solutions to the phases as you work (analogous to the <code class="language-plaintext highlighter-rouge">passcodes.txt</code> file from the zoo assignment).</li>
      <li><code class="language-plaintext highlighter-rouge">cookie.txt</code> — an 8-digit hex code that you will use as a unique identifier in your attacks.</li>
      <li><code class="language-plaintext highlighter-rouge">hex2raw</code> — a utility program that will help you to generate attack strings.
Ignore <code class="language-plaintext highlighter-rouge">rtarget*</code> and <code class="language-plaintext highlighter-rouge">farm.c</code></li>
    </ul>
  </li>
  <li><strong>For each phase:</strong>
    <ul>
      <li>Read about the phase. (<a href="#phase-1-make-ctarget-call-the-wrong-function">Phase1</a>, <a href="#phase-2-make-ctarget-call-the-wrong-function-with-an-int-parameter">Phase2</a>, <a href="#phase-3-make-ctarget-call-the-wrong-function-with-a-string-parameter">Phase3</a>)</li>
      <li>Use gdb (and <a href="#appendix-b-generating-byte-codes">gcc for some phases</a>) to figure out what bytes you want to write into (and past) the input buffer so as to corrupt the stack frame in whatever way is required to achieve your goal.</li>
      <li>Store the bytes you want to input as space-delimited bytes (2 hexadecimal digits each) in the <code class="language-plaintext highlighter-rouge">ctarget.phaseN</code> file (with N for whichever phase you’re working on).</li>
    </ul>

    <p>Note that your exploit strings must not contain the byte value 0x0a, since this is the ASCII code for newline (‘\n’) and <code class="language-plaintext highlighter-rouge">ctarget</code> will consider it the end of your input.</p>

    <ul>
      <li>Perform your attack like so:
        <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> cat ctarget.phaseN | ./hex2raw | ./ctarget
</code></pre></div>        </div>
      </li>
    </ul>

    <p>If you’re successful, ctarget will let you know.</p>
    <ul>
      <li>Make sure you run the attack on mantis so your success will get recorded.</li>
      <li>Check out your progress at <a href="http://cs208.mathcs.carleton.edu:1866/progress">http://cs208.mathcs.carleton.edu:1866/progress</a>
 Unless you run <code class="language-plaintext highlighter-rouge">ctarget</code> with the <code class="language-plaintext highlighter-rouge">-q</code> flag, your exploit string will be sent to the assignment server and tested. The server will then update your status on the progress page.</li>
    </ul>

    <p>There is no penalty for making mistakes in this assignment, nor are mistakes even recorded anywhere. Experiment at will!</p>

    <p>The progress server expects you to work on mantis.mathcs.carleton.edu. You can certainly do your work on any Linux x86-64 computer, but eventually, you’ll need to submit your solution to each phase from mantis.</p>
  </li>
  <li><strong>Celebrate!</strong></li>
</ol>

<h2 id="general-information-about-ctarget">GENERAL INFORMATION ABOUT CTARGET</h2>
<p><code class="language-plaintext highlighter-rouge">ctarget</code> reads strings from standard input. It does so using the function <code class="language-plaintext highlighter-rouge">getbuf</code>:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">unsigned</span> <span class="nf">getbuf</span><span class="p">()</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">BUFFER_SIZE</span><span class="p">];</span>
    <span class="n">Gets</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The function <code class="language-plaintext highlighter-rouge">Gets</code> is similar to the standard library function <code class="language-plaintext highlighter-rouge">gets</code> — it reads a string from standard input (terminated by ‘\n’ or end-of-file) and stores it including a null terminator at the specified destination address. In this code, you can see that the destination is an array <code class="language-plaintext highlighter-rouge">buf</code>, declared as having <code class="language-plaintext highlighter-rouge">BUFFER_SIZE</code> bytes. At the time your <code class="language-plaintext highlighter-rouge">ctarget</code> was generated, <code class="language-plaintext highlighter-rouge">BUFFER_SIZE</code> was a compile-time constant unique to your version of the program.</p>

<p>Functions <code class="language-plaintext highlighter-rouge">Gets</code> and <code class="language-plaintext highlighter-rouge">gets</code> have no way to determine whether their destination buffers are large enough to store the string they read. They just keep copying input bytes to the buffer until they encounter ‘\n’ or end-of-file. <strong>People who program using these input functions are at risk of buffer overflow attacks.</strong> (So you should never do that!)</p>

<p>(Note that <code class="language-plaintext highlighter-rouge">getbuf()</code> is really weird in a “this-is-a-classroom-exercise” sort of way. It reads data into the local variable <code class="language-plaintext highlighter-rouge">buf</code>, and then immediately returns without doing anything with the data. That seems dumb, right? What you need to imagine is that this same operation — declare a buffer and read data into it — is happening in the context of a real-life program, where the dangerous <code class="language-plaintext highlighter-rouge">Gets(buf)</code> line is followed by code that does something important with the contents of <code class="language-plaintext highlighter-rouge">buf</code>. This scenario — uncontrolled input followed by critical computation — is disturbingly common in important code that runs the world.)</p>

<p>For this assignment, we will refer to the bytes entered by the user as the <em>exploit string</em>. If your exploit string is sufficiently short, it won’t overrun the buffer <code class="language-plaintext highlighter-rouge">buf</code>, so <code class="language-plaintext highlighter-rouge">getbuf</code> will finish normally and return 1, as shown by this execution example (user input in yellow):</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./ctarget
Cookie: 0x1a7dd803
Type string: Look! A moose!
No exploit. Getbuf returned 0x1
Normal <span class="k">return</span>
</code></pre></div></div>

<p>Typically, though, an error occurs if you type a long string:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./ctarget
Cookie: 0x1a7dd803
Type string: This string may not express moose-related content concisely, but it is plenty long blah blah blah ... 
Ouch!: You caused a segmentation fault!
Better luck next <span class="nb">time
</span>FAILED
</code></pre></div></div>

<p>As the error message indicates, overrunning the buffer typically causes the program state to be corrupted, leading to a memory access error.</p>

<p>Because many of the bytes you are going to want to feed to <code class="language-plaintext highlighter-rouge">ctarget</code> will not be printable ASCII characters, you will usually use the technique mentioned in the previous section and elaborated in <a href="#appendix-a-using-hex2raw">Appendix A</a> — store your bytes in hexadecimal in a text file called <code class="language-plaintext highlighter-rouge">ctarget.phaseN</code> and use <code class="language-plaintext highlighter-rouge">hex2raw</code> to convert your text data to the desired bytes before piping the result to <code class="language-plaintext highlighter-rouge">ctarget</code>’s <code class="language-plaintext highlighter-rouge">stdin</code>. Here, for example, is what you might see if you have a correct solution to Phase 2:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat </span>ctarget.phase2 | ./hex2raw | ./ctarget
Cookie: 0x1a7dd803
Type string:Touch2!: You called touch2<span class="o">(</span>0x1a7dd803<span class="o">)</span>
Valid solution <span class="k">for </span>level 2 with target ctarget
PASS: Sent exploit string to server to be validated.
NICE JOB!
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">ctarget</code> has some command-line flags that might be handy. You can execute <code class="language-plaintext highlighter-rouge">ctarget -h</code> to read about them.</p>

<h2 id="phase-1-make-ctarget-call-the-wrong-function">PHASE 1: MAKE <code class="language-plaintext highlighter-rouge">CTARGET</code> CALL THE WRONG FUNCTION</h2>
<p>For phase 1, your exploit string will redirect the program to execute an existing function that it’s not intended to execute. Function <code class="language-plaintext highlighter-rouge">getbuf</code> is called within <code class="language-plaintext highlighter-rouge">ctarget</code> by a function <code class="language-plaintext highlighter-rouge">test</code>:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">1</span> <span class="kt">void</span> <span class="nf">test</span><span class="p">()</span> <span class="p">{</span>
<span class="mi">2</span>     <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
<span class="mi">3</span>     <span class="n">val</span> <span class="o">=</span> <span class="n">getbuf</span><span class="p">();</span>
<span class="mi">4</span>     <span class="n">printf</span><span class="p">(</span><span class="s">"No exploit. Getbuf returned 0x%x</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="mi">5</span> <span class="p">}</span>
</code></pre></div></div>

<p>When <code class="language-plaintext highlighter-rouge">getbuf</code> executes its return statement, the program ordinarily resumes execution within function <code class="language-plaintext highlighter-rouge">test</code> (at line 4 of this function). We want to change this behavior. Within the file <code class="language-plaintext highlighter-rouge">ctarget</code>, there is code for a function <code class="language-plaintext highlighter-rouge">touch1</code>:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">1</span> <span class="kt">void</span> <span class="nf">touch1</span><span class="p">()</span> <span class="p">{</span>
<span class="mi">2</span>     <span class="n">vlevel</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* Part of validation protocol */</span>
<span class="mi">3</span>     <span class="n">printf</span><span class="p">(</span><span class="s">"Touch1!: You called touch1()</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="mi">4</span>     <span class="n">validate</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="mi">5</span>     <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="mi">6</span><span class="p">}</span>
</code></pre></div></div>

<p>Your task is to get <code class="language-plaintext highlighter-rouge">ctarget</code> to execute the code for <code class="language-plaintext highlighter-rouge">touch1</code> when <code class="language-plaintext highlighter-rouge">getbuf</code> executes its return statement, rather than returning to test. Note that your exploit string may also corrupt parts of the stack not directly related to the this modified return statement, but that’s OK with us, since <code class="language-plaintext highlighter-rouge">touch1</code> causes the program to exit directly.</p>

<p>Some Advice:</p>

<ul>
  <li>All the information you need to devise your exploit string for this phase can be determined by examining a disassembled version of <code class="language-plaintext highlighter-rouge">ctarget</code>. Use <code class="language-plaintext highlighter-rouge">objdump -d ctarget</code> to get this disassembled version. (More specifically, I recommend <code class="language-plaintext highlighter-rouge">objdump -d ctarget &gt; disassembly.s</code> instead, so you can open the disassembled code in an editor so it’s easy to explore.)</li>
  <li>The idea is to position a byte representation of the starting address for <code class="language-plaintext highlighter-rouge">touch1</code> so that the <code class="language-plaintext highlighter-rouge">ret</code> instruction at the end of the code for <code class="language-plaintext highlighter-rouge">getbuf</code> will transfer control to <code class="language-plaintext highlighter-rouge">touch1</code>.</li>
  <li>Be careful about byte order. Remember little-endian!</li>
  <li>You will certainly want to use <code class="language-plaintext highlighter-rouge">gdb</code> to step through the program through the last few instructions of <code class="language-plaintext highlighter-rouge">getbuf</code> to make sure it is doing what you want. You’ll be modifying the contents of the stack on purpose, so don’t forget “<code class="language-plaintext highlighter-rouge">x/1ss $rsp</code>”, “<code class="language-plaintext highlighter-rouge">x/20dw 0x1234567</code>”, and similar <code class="language-plaintext highlighter-rouge">gdb</code> commands to see whether you’re modifying it the way you intend.</li>
  <li>The placement of <code class="language-plaintext highlighter-rouge">buf</code> within the stack frame for <code class="language-plaintext highlighter-rouge">getbuf</code> depends on the value of compile-time constant <code class="language-plaintext highlighter-rouge">BUFFER_SIZE</code>, as well the stack allocation strategy used by GCC. You will need to examine the disassembled code to determine its position.</li>
</ul>

<h2 id="phase-2-make-ctarget-call-the-wrong-function-with-an-int-parameter">PHASE 2: MAKE <code class="language-plaintext highlighter-rouge">CTARGET</code> CALL THE WRONG FUNCTION WITH AN INT PARAMETER</h2>
<p>Phase 2 involves placing a small amount of machine-language code on the stack as part of your exploit string, and then inducing the program to execute this <em>injected</em> code.</p>

<p>Within <code class="language-plaintext highlighter-rouge">ctarget</code> there is code for a function <code class="language-plaintext highlighter-rouge">touch2</code>:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">1</span>  <span class="kt">void</span> <span class="nf">touch2</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">2</span>     <span class="n">vlevel</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>       <span class="cm">/* Part of validation protocol */</span>
<span class="mi">3</span>     <span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="n">cookie</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">4</span>         <span class="n">printf</span><span class="p">(</span><span class="s">"Touch2!: You called touch2(0x%.8x)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="mi">5</span>         <span class="n">validate</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="mi">6</span>     <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="mi">7</span>         <span class="n">printf</span><span class="p">(</span><span class="s">"Misfire: You called touch2(0x%.8x)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="mi">8</span>         <span class="n">fail</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="mi">9</span>     <span class="p">}</span>
<span class="mi">10</span>    <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="mi">11</span> <span class="p">}</span>
</code></pre></div></div>

<p>Your task is to get <code class="language-plaintext highlighter-rouge">ctarget</code> to execute the code for <code class="language-plaintext highlighter-rouge">touch2</code> rather than returning to <code class="language-plaintext highlighter-rouge">test</code>. In this case, however, you must make it appear to <code class="language-plaintext highlighter-rouge">touch2</code> as if you have passed your cookie as its argument.</p>

<p>Some advice:</p>

<ul>
  <li>Your program’s cookie is in the file <code class="language-plaintext highlighter-rouge">cookie.txt</code> included in your <code class="language-plaintext highlighter-rouge">targetN.tar</code>.</li>
  <li>You will want to position a byte representation of the address of your injected code in such a way that <code class="language-plaintext highlighter-rouge">ret</code> instruction at the end of the code for <code class="language-plaintext highlighter-rouge">getbuf</code> will transfer control to it.</li>
  <li>As you may remember, the first argument to a function is passed in register <code class="language-plaintext highlighter-rouge">%rdi</code>. Your injected code should set <code class="language-plaintext highlighter-rouge">%rdi</code> to your cookie, and then use a <code class="language-plaintext highlighter-rouge">ret</code> instruction to transfer control to the first instruction in <code class="language-plaintext highlighter-rouge">touch2</code>.</li>
  <li>Do not attempt to use <code class="language-plaintext highlighter-rouge">jmp</code> or <code class="language-plaintext highlighter-rouge">call</code> instructions in your exploit code. The encodings of destination addresses for these instructions are difficult to formulate. Use <code class="language-plaintext highlighter-rouge">ret</code> instructions for all transfers of control, even when you are not returning from a <code class="language-plaintext highlighter-rouge">call</code>.</li>
  <li>See the instructions in <a href="#appendix-b-generating-byte-codes">Appendix B</a> on how to use tools to generate the byte-level representations of instruction sequences.</li>
</ul>

<h2 id="phase-3-make-ctarget-call-the-wrong-function-with-a-string-parameter">PHASE 3: MAKE CTARGET CALL THE WRONG FUNCTION WITH A STRING PARAMETER</h2>
<p>Like Phase 2, Phase 3 involves a code injection attack, but this time passing a string rather than an integer as a parameter.</p>

<p><code class="language-plaintext highlighter-rouge">ctarget</code> contains functions <code class="language-plaintext highlighter-rouge">hexmatch</code> and <code class="language-plaintext highlighter-rouge">touch3</code>:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* Compare string to hex represention of unsigned value */</span>
<span class="mi">1</span>  <span class="kt">int</span> <span class="nf">hexmatch</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">val</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sval</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">2</span>      <span class="kt">char</span> <span class="n">cbuf</span><span class="p">[</span><span class="mi">110</span><span class="p">];</span>
<span class="mi">3</span>      <span class="cm">/* Make position of check string unpredictable */</span>
<span class="mi">4</span>      <span class="kt">char</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">cbuf</span> <span class="o">+</span> <span class="n">random</span><span class="p">()</span> <span class="o">%</span> <span class="mi">100</span><span class="p">;</span>
<span class="mi">5</span>      <span class="n">sprintf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">"%.8x"</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="mi">6</span>      <span class="k">return</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">sval</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
<span class="mi">7</span>  <span class="p">}</span>
<span class="mi">8</span>
<span class="mi">9</span>  <span class="kt">void</span> <span class="nf">touch3</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">sval</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">10</span>     <span class="n">vlevel</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>    <span class="cm">/* Part of validation protocol */</span>
<span class="mi">11</span>     <span class="k">if</span> <span class="p">(</span><span class="n">hexmatch</span><span class="p">(</span><span class="n">cookie</span><span class="p">,</span> <span class="n">sval</span><span class="p">))</span> <span class="p">{</span>
<span class="mi">12</span>         <span class="n">printf</span><span class="p">(</span><span class="s">"Touch3!: You called touch3(</span><span class="se">\"</span><span class="s">%s</span><span class="se">\"</span><span class="s">)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">sval</span><span class="p">);</span>
<span class="mi">13</span>         <span class="n">validate</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
<span class="mi">14</span>     <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="mi">15</span>         <span class="n">printf</span><span class="p">(</span><span class="s">"Misfire: You called touch3(</span><span class="se">\"</span><span class="s">%s</span><span class="se">\"</span><span class="s">)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">sval</span><span class="p">);</span>
<span class="mi">16</span>         <span class="n">fail</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
<span class="mi">17</span>     <span class="p">}</span>
<span class="mi">18</span>     <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="mi">19</span> <span class="p">}</span>
</code></pre></div></div>

<p>Your task is to get <code class="language-plaintext highlighter-rouge">ctarget</code> to execute the code for <code class="language-plaintext highlighter-rouge">touch3</code> rather than returning to <code class="language-plaintext highlighter-rouge">test</code>. You must make it appear to <code class="language-plaintext highlighter-rouge">touch3</code> as if you have passed a string representation of your cookie as its parameter.</p>

<p>Some Advice:</p>

<ul>
  <li>You will need to include a string representation of your cookie in your exploit string. The string should consist of the eight hexadecimal digits (ordered from most to least significant) without a leading “0x.”</li>
  <li>Recall that a string is represented in C as a sequence of bytes followed by a byte with value 0. Type <code class="language-plaintext highlighter-rouge">man ascii</code> on any Linux machine (or a Mac) to see the byte representations of the characters you need.</li>
  <li>Your injected code should set register <code class="language-plaintext highlighter-rouge">%rdi</code> to the address of your cookie string.</li>
  <li>When functions <code class="language-plaintext highlighter-rouge">hexmatch</code> and <code class="language-plaintext highlighter-rouge">strncmp</code> are called, they push data onto the stack, overwriting portions of memory that held the buffer used by <code class="language-plaintext highlighter-rouge">getbuf</code>. As a result, you will need to be careful where you place the string representation of your cookie.</li>
</ul>

<h2 id="appendix-a-using-hex2raw">APPENDIX A: USING HEX2RAW</h2>
<p><code class="language-plaintext highlighter-rouge">hex2raw</code> is a command-line utility that takes as input a hex-formatted string. In this format, each byte value is represented by two hex digits. For example, the string “012ABC” could be entered in hex format as “30 31 32 41 42 43 00”.</p>

<p>The hex characters you pass to <code class="language-plaintext highlighter-rouge">hex2raw</code> should be separated by whitespace (blanks or newlines). I recommend separating different parts of your exploit string with newlines while you’re working on it. <code class="language-plaintext highlighter-rouge">hex2raw</code> supports C-style block comments, so you can mark off sections of your exploit string. For example:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>48 c7 c1 f0 11 40 00 /* mov $0x40011f0,%rcx */
</code></pre></div></div>

<p>Be sure to leave space around both the starting and ending comment strings (“/<em>”, “</em>/”), so that the comments will be properly ignored.</p>

<p>Don’t forget that byte order matters in many contexts. If, say, a phase is expecting a 4-byte int to be stored at a particular memory location, you’ll want to make sure you put the lowest-order byte of the int first in memory.</p>

<p>If you generate a hexformatted exploit string in the file <code class="language-plaintext highlighter-rouge">ctarget.phase1</code>, you can apply the raw string to <code class="language-plaintext highlighter-rouge">ctarget</code> in a couple different ways:</p>

<ul>
  <li>
    <p>You can set up a series of pipes to pass the string through <code class="language-plaintext highlighter-rouge">hex2raw</code></p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nb">cat </span>ctarget.phase1 | ./hex2raw | ./ctarget
</code></pre></div>    </div>
  </li>
  <li>
    <p>You can store the raw string in a file and provide the filename as a command-line argument:</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  ./hex2raw &lt; ctarget.phase1 <span class="o">&gt;</span> ctarget.phase1.raw
  ./ctarget <span class="nt">-i</span> ctarget.phase1.raw
</code></pre></div>    </div>

    <p>This approach also can be used when running from within GDB.</p>
  </li>
</ul>

<h2 id="appendix-b-generating-byte-codes">APPENDIX B: GENERATING BYTE CODES</h2>
<p>For phases 2 and 3, you need to send machine-language instructions as part of your input to <code class="language-plaintext highlighter-rouge">ctarget</code>. But how can you determine what bytes the desired instructions consist of?</p>

<p>You can use <code class="language-plaintext highlighter-rouge">gcc</code> as an assembler and <code class="language-plaintext highlighter-rouge">objdump</code> as a disassembler to make it convenient to generate the bytes in your desired instruction sequences. For example, suppose you write a file <code class="language-plaintext highlighter-rouge">example.s</code> containing the following assembly code:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Example of hand-generated assembly code
pushq   $0xabcdef  # Push value onto stack
addq    $17,%rax   # Add 17 to %rax
movl    %eax,%edx  # Copy lower 32 bits of %eax to %edx
</code></pre></div></div>

<p>The code can contain a mixture of instructions and data. Anything to the right of a ‘#’ character is a comment. You can now assemble and disassemble this file:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gcc <span class="nt">-c</span> example.s
objdump <span class="nt">-d</span> example.o <span class="o">&gt;</span> example.d
</code></pre></div></div>

<p>The generated file <code class="language-plaintext highlighter-rouge">example.d</code> contains the following:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>example.o: file format elf64-x86-64

Disassembly of section .text:
0000000000000000 &lt;.text&gt;:
    0: 68 ef cd ab 00        pushq  $0xabcdef
    5: 48 83 c0 11           add    $0x11,%rax
    9: 89 c2                 mov    %eax,%edx
</code></pre></div></div>

<p>The lines at the bottom show the machine code generated from the assembly language instructions. Each line has a hexadecimal number on the left indicating the instruction’s starting address (starting with 0), while the hex digits after the ‘:’ character indicate the actual bytes that make up the machine-language version of the instruction. Thus, we can see that the instruction <code class="language-plaintext highlighter-rouge">push $0xABCDEF</code> has hex-formatted machine-language code 68 ef cd ab 00.</p>

<p>From this file, you can get the byte sequence for the code:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>68 ef cd ab 00 48 83 c0 11 89 c2
</code></pre></div></div>

<p>This string can then be passed through <code class="language-plaintext highlighter-rouge">hex2raw</code> to generate an input string for the target programs. Alternatively, you can edit <code class="language-plaintext highlighter-rouge">example.d</code> to omit extraneous values and to contain C-style comments for readability, yielding:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>68 ef cd ab 00   /* pushq  $0xabcdef  */
48 83 c0 11      /* add    $0x11,%rax */
89 c2            /* mov    %eax,%edx  */
</code></pre></div></div>

<p>This is also a valid input you can pass through <code class="language-plaintext highlighter-rouge">hex2raw</code> before sending to one of the target programs.</p>

<h2 id="some-final-notes">SOME FINAL NOTES</h2>
<ul>
  <li>Section <a href="https://diveintosystems.org/book/C7-x86_64/buffer_overflow.html">7.10</a> of the textbook provides useful reference material for this assignment.</li>
  <li>This stuff feels weird at first, but you can figure it out! Draw pictures, step slowly through the code, take a look at the stack and the registers, figure out where function parameters are stored, and just gradually put together a picture of what’s going on for yourself. Talk to each other, talk to me, step away and take a walk, and come back to it again.</li>
  <li>Learning how to exploit software vulnerabilities helps you to understand those vulnerabilities and how to prevent them. At the same time, of course, this knowledge could potentially be used to harm other people. <a href="https://apps.carleton.edu/handbook/community/?a=student&amp;policy_id=6131">Don’t do that.</a></li>
</ul>

<h2 id="have-fun">HAVE FUN!</h2>

<h2 id="q--a">Q &amp; A</h2>
<p>Questions that have come up:</p>
<ul>
  <li>
    <p>I am getting a message that I have solved the phase but then cause a seg fault within notify_server; what gives?</p>

    <p>You might be running into an issue of stack alignment. Later in the code, there is a floating point instruction that assumes its parameter is stored at an address that is a multiple of 16. This can happen when you overflow the stack frame into the previous function’s stack frame and then doing two jumps (with ret) to your injected code and a touch function. Doing an extra ret without a corresponding 8-byte push makes rsp into a multiple of 8 that is not also a multiple of 16, which causes the issue later. <strong>The solution is to make sure that your <code class="language-plaintext highlighter-rouge">push</code> with your injected code before you <code class="language-plaintext highlighter-rouge">ret</code> to keep the stack aligned correctly.</strong></p>
  </li>
</ul>

  </div>

</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Anya E. Vostinar</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Anya E. Vostinar</li><li><a class="u-email" href="mailto:vostinar@carleton.edu">vostinar@carleton.edu</a></li><li><a class="u-email" href="https://linktr.ee/vostinar">https://linktr.ee/vostinar</a></li>
            Note that this website uses Google Analytics to collect and analyze usage.
        </ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/anyaevostinar"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">anyaevostinar</span></a></li><li><a href="https://www.twitter.com/AnyaEVostinar"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">AnyaEVostinar</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>The homepage of Prof. Anya E. Vostinar. I teach computer science and research the evolution of  symbiosis using digital evolution and agent-based modeling. I wrote the Symbulation platform.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
